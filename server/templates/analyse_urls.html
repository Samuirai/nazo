{% extends "base.html" %}

{% block title %}Collected Urls{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .mark {
            font-weight: bold;
            margin-left: 0;
            margin-right: 0;
            padding-left: 0;
            padding-right: 0;
        }

        .mark_blue {
            background-color: #5bc0de;
            border-color: #46b8da;
        }

        .mark_orange {
            background-color: #e99002;
            border-color: #d08002;
        }


    </style>
{% endblock %}

{% block content %}
    <ul class="breadcrumb">
        <li><a href="{{ url_for('get_hosts') }}">Hosts</a></li>
        <li class="active">Analyse URLs</li>
    </ul>
    <h1>Analyse URLs - {{host}}</h1>


    <div id="url_modal" class="modal large" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Create URL Filter</h4>
                </div>
                <div class="modal-body">
                    <p>Tag the URL by highlighting parts and asign a tag.</p>
                    <hr>
                    <div class="well well-sm" style="word-wrap:break-word;" id="active_url"></div>
                    
                    <table class="table table-striped table-hover ">
                        <tr>
                            <td><button type="button" onclick="apply_rule('id')" class="btn btn-info btn-xs">Tag as ID</button></td>
                            <td>part of the URL that is used as an ID</td>
                        </tr>
                        <tr>
                            <td><button type="button" onclick="apply_rule('file')" class="btn btn-warning btn-xs">Tag as File</button></td>
                            <td>part of the URL that refers to a file/path</td>
                        </tr>
                        <tr>
                            <td><i>{ nothing }</i></td>
                            <td>Not tagged parts considered fixed that doesn't change</td>
                        </tr>
                    </table>

                    <div id="modal_message" style="display: none;" class="alert alert-dismissable alert-success">
                        <button type="button" class="close" data-dismiss="alert">×</button>
                        <strong>Test Results:</strong><br>
                        <span></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Close</button>
                    <button type="button" onclick="test_filter()" class="btn btn-primary btn-sm">Test Filter</button>
                    <button type="button" onclick="save_filter()" class="btn btn-success btn-sm">Save/Apply Filter</button>
                </div>
            </div>
        </div>
    </div>

    {% if sliced %} 
        <div class="alert alert-dismissable alert-danger">
          <button type="button" class="close" data-dismiss="alert">×</button>
          <strong>Warning!</strong><br>
          Only 100 URLs displayed from {{ num_all_urls }}. Start grouping URLs.
        </div>
    {% endif %}

    <h3>inwards</h3>
    <table class="table table-striped table-hover ">
        <tr><th>URL</th><th>Action</th></tr>

        {% for url in filterd_urls.in_urls %}
            <tr>
                <td><a href="{{ url }}">{{ url }}</a></td>
                <td>
                    <a onclick="open_filter_dialog(this, '{{ url }}')" class="btn btn-primary btn-xs">
                        <span class="glyphicon glyphicon-filter"></span>
                    </a>
                </td>
            </tr>
        {% endfor %}
    </table>

    <h3>outwards</h3>
    <table class="table table-striped table-hover ">
        <tr><th>URL</th><th>Action</th></tr>

        {% for url in filterd_urls.out_urls %}
            <tr><td>{{ url }}</td><td></td></tr>
        {% endfor %}
    </table>



{% endblock %}

{% block bottom_script %}
    <script>
        var urls = Array();
        var filter = [];

        {% for url in filterd_urls.in_urls %} urls.push("{{ url }}");{% endfor %}

        var active_selection;
        var active_range;
        var active_selected_text;
        var active_url;


        save_filter = function() {

            var request = new XMLHttpRequest();  
            request.open('POST', 'http://127.0.0.1:5000/api/filter/urls/{{host}}', true);
            request.setRequestHeader("Content-Type", "application/json");
            request.onload = function() {
                response = JSON.parse(request.response);
            }
            request.send(JSON.stringify({"filter": filter}));

            $('#url_modal').modal('hide');
        }

        test_filter = function() {

            var request = new XMLHttpRequest();  
            request.open('POST', 'http://127.0.0.1:5000/api/test_filter/urls/{{host}}', true);
            request.setRequestHeader("Content-Type", "application/json");
            request.onload = function() {
                response = JSON.parse(request.response);
                $("#modal_message").fadeIn();
                $("#modal_message span").text( "This filter groups "+(response.pre_filter_num-response.post_filter_num)+" URLs");
            }
            request.send(JSON.stringify({"filter": filter}));
        }

        open_filter_dialog = function(t, url) {
            filter = [];
            url = t.parentElement.parentElement.children[0].children[0].pathname;
            active_url = url;
            $("#modal_message").hide();
            $("#active_url").text(url);
            $('#url_modal').modal('show');
        }

        apply_rule = function(rule) {          
            var newNode = document.createElement("span");
            if(rule=='id') {
                newNode.className = "mark mark_blue";
            } else if(rule=='file') {
                newNode.className = "mark mark_orange";
            }

            string_part = range.commonAncestorContainer.textContent;
            found = false;
            for(var i=0; i<filter.length; ++i) {
                if(filter[i]['s'] == string_part) {
                    found = true;
                    if(filter[i]['t'] == "fixed") {
                        filter.splice(i, 1);
                        filter.splice(i, 0, {
                            's': string_part.substring(0,range.startOffset),
                            't': 'fixed',
                        });
                        filter.splice(i+1, 0, {
                            's': string_part.substring(range.startOffset,range.endOffset),
                            't': rule,
                        });
                        filter.splice(i+2, 0, {
                            's': string_part.substring(range.endOffset),
                            't': 'fixed',
                        });
                        active_range.surroundContents(newNode); 
                    }
                }
            }

            if(!found) {
                filter.push({
                    's': string_part.substring(0,range.startOffset),
                    't': 'fixed',
                });
                filter.push({
                    's': string_part.substring(range.startOffset,range.endOffset),
                    't': rule,
                });
                filter.push({
                    's': string_part.substring(range.endOffset),
                    't': 'fixed',
                });
                active_range.surroundContents(newNode); 
            }     
            active_selection = undefined;
            active_range = undefined;
            active_selected_text = undefined;
        }

        $("#active_url").mouseup(function() {
            selection = window.getSelection();
            range  = window.getSelection().getRangeAt(0);
            
            if(range.commonAncestorContainer.toString() == "[object Text]") {
                selected_text = selection.toString();
                active_selection = undefined;
                active_range = undefined;
                active_selected_text = undefined;
                if(selected_text.length>0) {
                    active_selection = selection;
                    active_range = range;
                    active_selected_text = selected_text;
                    //filter[]
                    
                }
            }
        });

    </script>
{% endblock %}